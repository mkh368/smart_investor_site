import streamlit as st
import pandas as pd
import requests
import time
from bs4 import BeautifulSoup

# ุชูุธูุงุช ุตูุญู
st.set_page_config(page_title="ุณุฑูุงูโฺฏุฐุงุฑ ููุดููุฏ", layout="wide")

# ููุงุฑ ฺฉูุงุฑ ุจุฑุง ูุงูุจุฑ
pages = {
    "ุตูุญู ุงุตู": "home",
    "ูพุฑุชูู ููููู": "portfolio"
}
page = st.sidebar.radio("๐ ุงูุชุฎุงุจ ุจุฎุด", list(pages.keys()))

# ุชุงุจุน ุฏุฑุงูุช ููุช ุฑูุฒุงูู ุงุฒ ูุจโุณุงุช TSETMC
@st.cache_data(ttl=3600)
def fetch_current_price(instrument_id):
    """
    ุงู ุชุงุจุน ููุช ูพุงุงู ุฑูุฒุงูู ุฑุง ุจุฑุง ฺฉ ููุงุฏ ุจุง ุดูุงุณูโ TSETMC ุจุงุฒูโฺฏุฑุฏุงูุฏ.
    ุดูุงุณูโูุง ุจุงุฏ ุฏุฑ mapping ูพุงู ุชุนุฑู ุดููุฏ.
    """
    url = f"https://www.tsetmc.com/Loader.aspx?ParTree=15131F&i={instrument_id}"
    try:
        res = requests.get(url, timeout=5)
        soup = BeautifulSoup(res.text, "html.parser")
        # ุชฺฏโูุง ฺฉู ููุช ุฑุง ูฺฏูุฏุงุฑ ูโฺฉููุฏ ููฺฉู ุงุณุช ูุชูุงูุช ุจุงุดูุฏุ ูุทูุงู ุจุฑุฑุณ ฺฉูุฏ
        price_str = soup.find(id="lblLast").get_text().replace(',', '')
        return float(price_str)
    except Exception as e:
        st.error(f"ุฎุทุง ุฏุฑ ุฏุฑุงูุช ููุช ุจุฑุง ุดูุงุณู {instrument_id}: {e}")
        return None

# ูฺฏุงุดุช ููุงุฏ ุจู ุดูุงุณู TSETMC
symbol_to_id = {
    'ุดูพูุง': '10021204322607755',
    'ูููุงุฏ': '26331843695355338',
    'ููู': '52172491489979424'
    # ุดูุงุณู ุณุงุฑ ููุงุฏูุง ุฑุง ุงูุฌุง ุงุถุงูู ฺฉูุฏ
}

if pages[page] == "home":
    # ุตูุญู ุงุตู
    st.title("๐ผ ุฎูุงุตู ฺฉุชุงุจ ุณุฑูุงูโฺฏุฐุงุฑ ููุดููุฏ")
    st.markdown("""
    ุจู ูุจโุณุงุช ุฎูุด ุขูุฏุฏ ฺฉู ุจุฑ ุงุณุงุณ ุงุตูู ุจูุฌุงูู ฺฏุฑุงูุงู ุทุฑุงุญ ุดุฏู ุงุณุช โ ูพุฏุฑ ุณุฑูุงูโฺฏุฐุงุฑ ุงุฑุฒุด.

    ุฏุฑ ุงูุฌุงุ ููุงูู ฺฉูุฏ ฺฉุชุงุจ **ุณุฑูุงูโฺฏุฐุงุฑ ููุดููุฏ** ุฑุง ุจู ุฒุจุงู ุณุงุฏู ุจุฑุฑุณ ูโฺฉููุ ู ุณูพุณ ุงุฒ ุขูโูุง ุฏุฑ ูพุฑุชููโูุง ููููู ุงุณุชูุงุฏู ูโฺฉูู ฺฉู ุนููฺฉุฑุฏ ุขูโูุง ุฑุง ุจูโุตูุฑุช ุฑูุฒุงูู ูพฺฏุฑ ุฎูุงูู ฺฉุฑุฏ.
    """)

    st.header("๐ ูุตูโูุง ููู ู ููุงูู ฺฉูุฏ")
    st.markdown("""
    ### ฑ. ููููู "ุญุงุดู ุงููุช"
    ุนู ุณูุงู ุจุฎุฑุฏ ฺฉู ููุช ุจุงุฒุงุฑ ุขู ุจุณุงุฑ ูพุงูโุชุฑ ุงุฒ ุงุฑุฒุด ุฐุงุช ุขู ุจุงุดุฏ. ุงู ุงุฎุชูุงูุ ูุญุงูุธ ุดูุง ุฏุฑ ุจุฑุงุจุฑ ุฎุทุง ูุญุงุณุจู ู ููุณุงูุงุช ุจุงุฒุงุฑ ุงุณุช.

    ### ฒ. ุดุฎุตุช ุขูุง ุจุงุฒุงุฑ (Mr. Market)
    ุจุงุฒุงุฑ ููุดู ููุทู ูุณุช. ุขูุง ุจุงุฒุงุฑ ูุฑ ุฑูุฒ ููุช ูพุดููุงุฏ ูุชูุงูุช ุงุฑุงุฆู ูโุฏูุฏุ ุงูุง ุดูุง ูุฌุจูุฑ ูุณุชุฏ ููุดู ูุนุงููู ฺฉูุฏ.

    ### ณ. ุณุฑูุงูโฺฏุฐุงุฑ ุชุฏุงูุน ุฏุฑ ููุงุจู ฺฉุงุฑุขูุฑูุงูู
    - **ุณุฑูุงูโฺฏุฐุงุฑ ุชุฏุงูุน**: ุฏูุจุงู ุณูุงู ุจุง ุซุจุงุช ู ุฑุณฺฉ ูพุงู ุงุณุช.
    - **ุณุฑูุงูโฺฏุฐุงุฑ ฺฉุงุฑุขูุฑูุงูู**: ุจู ุฏูุจุงู ูุฑุตุชโูุง ุจุฑุง ุฎุฑุฏ ุณูุงู ฺฉูโุงุฑุฒุดโฺฏุฐุงุฑโุดุฏู ู ูพุชุงูุณู ุฑุดุฏ ุจุงูุง.

    ### ด. ุชูุงูุช ุจู ุณุฑูุงูโฺฏุฐุงุฑ ู ุณูุชูโุจุงุฒ
    ุณุฑูุงูโฺฏุฐุงุฑ = ุชุญููุ ุญุงุดู ุงููุชุ ุฏุฏ ุจููุฏูุฏุช.
    ุณูุชูโุจุงุฒ = ุญุฏุณ ุฒุฏู ุฌูุช ุจุงุฒุงุฑ ุจุฏูู ุชุญูู ุจูุงุฏ.
    """)

    st.header("๐ง ุงููุงุน ุณุฑูุงูโฺฏุฐุงุฑ ุงุฒ ุฏุฏ ฺฏุฑุงูุงู")
    col1, col2 = st.columns(2)
    with col1:
        st.subheader("ุณุฑูุงูโฺฏุฐุงุฑ ุชุฏุงูุน")
        st.markdown("""
        - ุงูุชุฎุงุจ ุณูุงู ุจุฒุฑฺฏ ู ูุนุชุจุฑ
        - ุชูุฑฺฉุฒ ุจุฑ ุฏุฑุขูุฏ ุซุงุจุช ู ุณูุฏ ุชูุณู
        - ุญุฏุงูู ูุนุงููู ุฏุฑ ุณุงู
        - ุฑุณฺฉโฺฏุฑุฒ
        """)
    with col2:
        st.subheader("ุณุฑูุงูโฺฏุฐุงุฑ ฺฉุงุฑุขูุฑูุงูู")
        st.markdown("""
        - ุชุญูู ุนูู ุดุฑฺฉุชโูุง
        - ุฌุณุชโูุฌู ุจุฑุง ุณูุงู ุฒุฑููุช ูุงูุน
        - ูพุฐุฑุด ููุณุงู ุจุดุชุฑ ุฏุฑ ููุงุจู ุจุงุฒุฏู ุจุงูููู ุจุดุชุฑ
        - ุชุญูู ูุณุจุชโูุง ูุงู
        """)

    st.markdown("---")
    st.markdown("๐งพ ุงู ูุญุชูุง ุตุฑูุงู ุฌูุช ุขููุฒุด ู ุงูุฒุงุด ุฏุงูุด ูุงู ุงุณุช ู ุชูุตู ุณุฑูุงูโฺฏุฐุงุฑ ูุญุณูุจ ููโุดูุฏ.")

elif pages[page] == "portfolio":
    # ุตูุญู ูพุฑุชูู ููููู
    st.title("๐ ูพุฑุชูู ููููู")
    st.markdown("ุฏุฑ ุงู ุจุฎุดุ ูพุฑุชูู ุณูุฏ ุชูุณู ุฑุง ุจุง ุนููฺฉุฑุฏ ุฑูุฒุงูู ูุดุงูุฏู ฺฉูุฏ.")

    # ุฏุงุฏูโูุง ุงููู ูพุฑุชูู
    data = {
        'ููุงุฏ': ['ุดูพูุง', 'ูููุงุฏ', 'ููู'],
        'ูุฒู (%)': [40, 30, 30],
        'ููุช ุฎุฑุฏ': [2500, 1200, 800],
        'ุชุงุฑุฎ ุฎุฑุฏ': ['2025-01-01', '2025-01-01', '2025-01-01']
    }
    df = pd.DataFrame(data)

    # ุฏุฑุงูุช ููุชโูุง ุฌุงุฑ ู ูุญุงุณุจู ุจุงุฒุฏู
    current_prices = []
    returns = []
    for symbol, buy_price in zip(df['ููุงุฏ'], df['ููุช ุฎุฑุฏ']):
        inst_id = symbol_to_id.get(symbol)
        price = fetch_current_price(inst_id) if inst_id else None
        current_prices.append(price)
        if price:
            returns.append((price - buy_price) / buy_price * 100)
        else:
            returns.append(None)
        time.sleep(1)  # ุฌููฺฏุฑ ุงุฒ ุงุฑุณุงู ุฏุฑุฎูุงุณุชโูุง ุณุฑุน ูพุงูพ

    df['ููุช ุฌุงุฑ'] = current_prices
    df['ุจุงุฒุฏู (%)'] = returns

    st.subheader("๐ต ูพุฑุชูู ุณูุฏ ุชูุณู")
    st.table(df)

    # ูุญุงุณุจู ุจุงุฒุฏู ฺฉู ูพุฑุชูู
    weighted_return = sum((r * w / 100) for r, w in zip(returns, df['ูุฒู (%)']) if r is not None)
    st.markdown(f"**ุจุงุฒุฏู ฺฉู ูพุฑุชูู: {weighted_return:.2f}%**")

    st.markdown("---")
    st.markdown("๐งพ ุงู ูพุฑุชูู ุตุฑูุงู ููููู ุงุณุช ู ุชูุตู ุณุฑูุงูโฺฏุฐุงุฑ ูุณุช.")
